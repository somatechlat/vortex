# ═══════════════════════════════════════════════════════════════════════════════
# VORTEX Tiltfile
# ═══════════════════════════════════════════════════════════════════════════════
#
# ⚠️  DEPLOYMENT STACK: Colima + Minikube + Tilt (NO DOCKER DESKTOP)
#
# COMPLETELY ISOLATED CLUSTER:
#   - Minikube Profile: 'vortex' (10GB RAM, 20GB disk, 4 CPUs)
#   - kubectl Context: 'vortex'
#   - Namespace: 'vortex'
#   - This cluster does NOT interfere with any other agents or profiles
#
# ═══════════════════════════════════════════════════════════════════════════════

# Enforce isolated 'vortex' context - refuse to run on any other cluster
allow_k8s_contexts('vortex')

# ═══════════════════════════════════════════════════════════════════════════════
#                    CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════

config.define_string("namespace", args=True)
cfg = config.parse()
namespace = cfg.get("namespace", "vortex")

# Ensure namespace exists
k8s_yaml(blob("""
apiVersion: v1
kind: Namespace
metadata:
  name: %s
  labels:
    app.kubernetes.io/name: vortex
    app.kubernetes.io/part-of: vortex-gen-3
""" % namespace))

# ═══════════════════════════════════════════════════════════════
#                    RESOURCE QUOTAS (Apply First)
# ═══════════════════════════════════════════════════════════════

k8s_yaml('k8s/base/resourcequota.yaml')
k8s_yaml('k8s/base/limitrange.yaml')

# ═══════════════════════════════════════════════════════════════
#                    TIER 0: ROOT SERVICES (No Dependencies)
# ═══════════════════════════════════════════════════════════════

# PostgreSQL - Root of dependency tree
k8s_yaml('k8s/base/db/postgres.yaml')
k8s_resource(
    'postgres',
    port_forwards=['11202:5432'],
    labels=['tier-0-root'],
)

# Vault - Secrets management (no deps)
k8s_yaml('k8s/base/security/vault.yaml')
k8s_resource(
    'vault',
    port_forwards=['11200:8200'],
    labels=['tier-0-root'],
)

# ═══════════════════════════════════════════════════════════════
#                    TIER 1: DB-DEPENDENT SERVICES
# ═══════════════════════════════════════════════════════════════

# Keycloak - Depends on Postgres for auth DB
k8s_yaml('k8s/base/security/keycloak.yaml')
k8s_resource(
    'keycloak',
    port_forwards=['11201:8080'],
    labels=['tier-1-auth'],
    resource_deps=['postgres', 'vault'],
)

# Milvus - Vector DB (depends on Postgres for metadata)
k8s_yaml('k8s/base/db/milvus.yaml')
k8s_resource(
    'milvus',
    port_forwards=['11203:19530', '11204:9091'],
    labels=['tier-1-db'],
    resource_deps=['postgres'],
)

# ═══════════════════════════════════════════════════════════════
#                    TIER 2: SECURITY/AUTHZ SERVICES
# ═══════════════════════════════════════════════════════════════

# SpiceDB - ReBAC (depends on Postgres for tuples)
k8s_yaml('k8s/base/security/spicedb.yaml')
k8s_resource(
    'spicedb',
    port_forwards=['11205:50051', '11206:8443'],
    labels=['tier-2-security'],
    resource_deps=['postgres', 'keycloak'],
)

# ═══════════════════════════════════════════════════════════════
#                    TIER 3: CORE ENGINE (Rust)
# ═══════════════════════════════════════════════════════════════

docker_build(
    'vortex-core',
    context='.',
    dockerfile='docker/core/Dockerfile',
    live_update=[
        sync('./crates', '/app/crates'),
        run('cargo build --release', trigger=['./crates']),
    ],
)

k8s_yaml('k8s/base/core/deployment.yaml')
k8s_yaml('k8s/base/core/service.yaml')
k8s_yaml('k8s/base/core/configmap.yaml')
k8s_yaml('k8s/base/storage/data-pvc.yaml')
k8s_yaml('k8s/base/storage/models-pvc.yaml')

k8s_resource(
    'vortex-core',
    port_forwards=['11188:11188', '11189:11189', '11191:11191'],
    labels=['tier-3-backend'],
    resource_deps=['postgres', 'spicedb', 'milvus', 'vault'],
)

# ═══════════════════════════════════════════════════════════════
#                    TIER 4: COMPUTE FABRIC (Python Workers)
# ═══════════════════════════════════════════════════════════════

docker_build(
    'vortex-worker',
    context='.',
    dockerfile='docker/worker/Dockerfile',
    live_update=[
        sync('./worker', '/app/worker'),
    ],
)

k8s_yaml('k8s/base/worker/deployment.yaml')

k8s_resource(
    'vortex-worker',
    labels=['tier-4-compute'],
    resource_deps=['vortex-core'],
)

# ═══════════════════════════════════════════════════════════════
#                    TIER 5: FRONTEND UI (Svelte/Nginx)
# ═══════════════════════════════════════════════════════════════

docker_build(
    'vortex-ui',
    context='ui',
    dockerfile='docker/ui/Dockerfile',
    live_update=[
        sync('./ui/src', '/app/src'),
        run('bun run build', trigger=['./ui/src']),
    ],
)

k8s_yaml('k8s/base/ui/deployment.yaml')
k8s_yaml('k8s/base/ui/service.yaml')

k8s_resource(
    'vortex-ui',
    port_forwards=['11100:80'],
    labels=['tier-5-frontend'],
    resource_deps=['vortex-core'],
)

# ═══════════════════════════════════════════════════════════════
#                    LOCAL DEV RESOURCES
# ═══════════════════════════════════════════════════════════════

local_resource(
    'cargo-check',
    cmd='cargo check --workspace',
    deps=['./crates'],
    labels=['lint'],
    auto_init=False,
)

local_resource(
    'rust-test',
    cmd='cargo test --workspace',
    deps=['./crates'],
    labels=['test'],
    auto_init=False,
)

# Store HuggingFace token in Vault (run once after Vault is up)
local_resource(
    'vault-init',
    cmd='''
        curl -s -X POST http://localhost:11200/v1/secret/data/vortex/huggingface \
        -H "X-Vault-Token: vortex-dev-token" \
        -d '{"data": {"token": "'"$HF_TOKEN"'"}}'
    ''',
    labels=['security'],
    auto_init=False,
    resource_deps=['vault'],
)

