# ═══════════════════════════════════════════════════════════════════════════════
# VORTEX Tiltfile
# ═══════════════════════════════════════════════════════════════════════════════
#
# ⚠️  DEPLOYMENT STACK: Colima + Minikube + Tilt (NO DOCKER DESKTOP)
#
# COMPLETELY ISOLATED CLUSTER (VFKit / Native Provisioning)
#
# ═══════════════════════════════════════════════════════════════════════════════

allow_k8s_contexts('vortex')

# ═══════════════════════════════════════════════════════════════════════════════
#                    CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════

config.define_string("namespace", args=True)
cfg = config.parse()
namespace = cfg.get("namespace", "vortex")

# Ensure namespace exists
k8s_yaml(blob("""
apiVersion: v1
kind: Namespace
metadata:
  name: %s
  labels:
    app.kubernetes.io/name: vortex
    app.kubernetes.io/part-of: vortex-gen-3
""" % namespace))

# ═══════════════════════════════════════════════════════════════
#                    RESOURCE QUOTAS (Apply First)
# ═══════════════════════════════════════════════════════════════

k8s_yaml('k8s/base/resourcequota.yaml')
k8s_yaml('k8s/base/limitrange.yaml')

# ═══════════════════════════════════════════════════════════════
#                    TIER 0: ROOT SERVICES (No Dependencies)
# ═══════════════════════════════════════════════════════════════

# PostgreSQL - Root of dependency tree
k8s_yaml('k8s/base/db/postgres.yaml')
k8s_resource(
    'postgres',
    port_forwards=['11202:5432'],
    labels=['tier-0-root'],
)

# Vault - Secrets management (no deps)
k8s_yaml('k8s/base/security/vault.yaml')
k8s_resource(
    'vault',
    port_forwards=['11200:8200'],
    labels=['tier-0-root'],
)

# ═══════════════════════════════════════════════════════════════
#                    TIER 1: DB-DEPENDENT SERVICES
# ═══════════════════════════════════════════════════════════════

# Keycloak - Depends on Postgres for auth DB
k8s_yaml('k8s/base/security/keycloak.yaml')
k8s_resource(
    'keycloak',
    port_forwards=['11201:8080'],
    labels=['tier-1-auth'],
    resource_deps=['postgres', 'vault'],
)

# Milvus - Vector DB (depends on Postgres for metadata)
k8s_yaml('k8s/base/db/milvus.yaml')
k8s_resource(
    'milvus',
    port_forwards=['11203:19530', '11204:9091'],
    labels=['tier-1-db'],
    resource_deps=['postgres'],
)

# ═══════════════════════════════════════════════════════════════
#                    TIER 2: SECURITY/AUTHZ SERVICES
# ═══════════════════════════════════════════════════════════════

# SpiceDB - ReBAC (depends on Postgres for tuples)
k8s_yaml('k8s/base/security/spicedb.yaml')
k8s_resource(
    'spicedb',
    port_forwards=['11205:50051', '11206:8443'],
    labels=['tier-2-security'],
    resource_deps=['postgres', 'keycloak'],
)

# ═══════════════════════════════════════════════════════════════
#                    TIER 3: CORE ENGINE (Rust)
# ═══════════════════════════════════════════════════════════════

# Native Host Build -> Cluster Injection
custom_build(
    'vortex-core',
    'cargo build --release --workspace && ' +
    'echo "FROM debian:bookworm-slim" > .Dockerfile.core.tmp && ' +
    'echo "RUN apt-get update && apt-get install -y libssl3 ca-certificates curl && rm -rf /var/lib/apt/lists/*" >> .Dockerfile.core.tmp && ' +
    'echo "COPY target/release/vortex-core /app/vortex-core" >> .Dockerfile.core.tmp && ' +
    'echo "WORKDIR /app" >> .Dockerfile.core.tmp && ' +
    'echo "CMD [\\"./vortex-core\\"]" >> .Dockerfile.core.tmp && ' +
    'minikube image build -t $EXPECTED_REF -p vortex -f .Dockerfile.core.tmp . && ' +
    'rm .Dockerfile.core.tmp',
    ['./target/release/vortex-core'], # Watch the BINARY
    live_update=[
        sync('./target/release/vortex-core', '/app/vortex-core'),
        run('kill 1'), # Force container restart
    ],
    skips_local_docker=True,
)

k8s_yaml('k8s/base/core/deployment.yaml')
k8s_yaml('k8s/base/core/service.yaml')
k8s_yaml('k8s/base/core/configmap.yaml')
k8s_yaml('k8s/base/storage/data-pvc.yaml')
k8s_yaml('k8s/base/storage/models-pvc.yaml')

k8s_resource(
    'vortex-core',
    port_forwards=['11188:11188', '11189:11189', '11191:11191'],
    labels=['tier-3-backend'],
    resource_deps=['postgres', 'spicedb', 'milvus', 'vault'],
)

# ═══════════════════════════════════════════════════════════════
#                    TIER 4: COMPUTE FABRIC (Python Workers)
# ═══════════════════════════════════════════════════════════════

custom_build(
    'vortex-worker',
    'echo "FROM python:3.12-slim" > .Dockerfile.worker.tmp && ' +
    'echo "RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*" >> .Dockerfile.worker.tmp && ' +
    'echo "COPY worker /app/worker" >> .Dockerfile.worker.tmp && ' +
    'echo "WORKDIR /app/worker" >> .Dockerfile.worker.tmp && ' +
    'echo "RUN pip install -e ." >> .Dockerfile.worker.tmp && ' +
    'echo "CMD [\\"python\\", \\"vortex_worker/main.py\\"]" >> .Dockerfile.worker.tmp && ' +
    'minikube image build -t $EXPECTED_REF -p vortex -f .Dockerfile.worker.tmp . && ' +
    'rm .Dockerfile.worker.tmp',
    ['./worker'],
    live_update=[
        sync('./worker', '/app/worker'),
    ],
    skips_local_docker=True,
)

k8s_yaml('k8s/base/worker/deployment.yaml')

k8s_resource(
    'vortex-worker',
    labels=['tier-4-compute'],
    resource_deps=['vortex-core'],
)

# ═══════════════════════════════════════════════════════════════
#                    TIER 5: FRONTEND UI (Svelte/Nginx)
# ═══════════════════════════════════════════════════════════════

custom_build(
    'vortex-ui',
    'cd ui && bun run build && cd .. && ' +
    'echo "FROM nginx:alpine" > .Dockerfile.ui.tmp && ' +
    'echo "COPY ui/dist /usr/share/nginx/html" >> .Dockerfile.ui.tmp && ' +
    'echo "COPY ui/nginx.conf /etc/nginx/conf.d/default.conf" >> .Dockerfile.ui.tmp && ' +
    'echo "EXPOSE 80" >> .Dockerfile.ui.tmp && ' +
    'echo "CMD [\\"nginx\\", \\"-g\\", \\"daemon off;\\"]" >> .Dockerfile.ui.tmp && ' +
    'minikube image build -t $EXPECTED_REF -p vortex -f .Dockerfile.ui.tmp . && ' +
    'rm .Dockerfile.ui.tmp',
    ['./ui/dist'], # Watch the DIST output
    live_update=[
        sync('./ui/dist', '/usr/share/nginx/html'),
        run('nginx -s reload'),
    ],
    skips_local_docker=True,
)

k8s_yaml('k8s/base/ui/deployment.yaml')
k8s_yaml('k8s/base/ui/service.yaml')

k8s_resource(
    'vortex-ui',
    port_forwards=['11100:80'],
    labels=['tier-5-frontend'],
    resource_deps=['vortex-core'],
)

# ═══════════════════════════════════════════════════════════════
#                    LOCAL DEV RESOURCES
# ═══════════════════════════════════════════════════════════════

local_resource(
    'build-core',
    cmd='cargo build --release --workspace',
    deps=['./crates'],
    labels=['build'],
)

local_resource(
    'build-ui',
    cmd='cd ui && bun run build',
    deps=['./ui/src'],
    labels=['build'],
)

local_resource(
    'cargo-check',
    cmd='cargo check --workspace',
    deps=['./crates'],
    labels=['lint'],
    auto_init=False,
)

# Store HuggingFace token in Vault (run once after Vault is up)
local_resource(
    'vault-init',
    cmd='''
        curl -s -X POST http://localhost:11200/v1/secret/data/vortex/huggingface \
        -H "X-Vault-Token: vortex-dev-token" \
        -d '{"data": {"token": "'"$HF_TOKEN"'"}}'
    ''',
    labels=['security'],
    auto_init=False,
    resource_deps=['vault'],
)
