# VORTEX Docker Compose
# Local development without Kubernetes
# For testing individual services before K8s deployment

version: '3.9'

x-common-env: &common-env
  RUST_LOG: info
  VORTEX_ENV: development

services:
  # ═══════════════════════════════════════════════════════════════
  #                    CORE ENGINE (Rust)
  # ═══════════════════════════════════════════════════════════════
  core:
    build:
      context: .
      dockerfile: docker/core/Dockerfile
    container_name: vortex-core
    environment:
      <<: *common-env
      VORTEX_DB_PATH: /data/vortex.db
      VORTEX_SHM_NAME: /vortex-shm
      VORTEX_IPC_PATH: /tmp/vortex.sock
    ports:
      - "11188:11188"  # HTTP API
      - "11189:11189"  # WebSocket
      - "11191:11191"  # Prometheus metrics
    volumes:
      - vortex-data:/data
      - vortex-shm:/dev/shm
      - vortex-sock:/tmp
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
        reservations:
          memory: 256M
    depends_on:
      - worker
    networks:
      - vortex-net

  # ═══════════════════════════════════════════════════════════════
  #                    COMPUTE FABRIC (Python)
  # ═══════════════════════════════════════════════════════════════
  worker:
    build:
      context: .
      dockerfile: docker/worker/Dockerfile
    container_name: vortex-worker
    environment:
      <<: *common-env
      VORTEX_SLOT_ID: "0"
      VORTEX_SHM_NAME: /vortex-shm
      VORTEX_IPC_PATH: /tmp/vortex.sock
      CUDA_VISIBLE_DEVICES: "0"
    volumes:
      - vortex-shm:/dev/shm
      - vortex-sock:/tmp
      - vortex-models:/models
    deploy:
      resources:
        limits:
          memory: 6G
          cpus: '4'
        reservations:
          memory: 1G
    # Enable GPU if available
    # runtime: nvidia
    networks:
      - vortex-net

  # ═══════════════════════════════════════════════════════════════
  #                    FRONTEND UI (Svelte)
  # ═══════════════════════════════════════════════════════════════
  ui:
    build:
      context: ui
      dockerfile: ../docker/ui/Dockerfile
    container_name: vortex-ui
    ports:
      - "11100:80"
    environment:
      VORTEX_API_URL: http://core:11188
      VORTEX_WS_URL: ws://core:11189
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    depends_on:
      - core
    networks:
      - vortex-net

networks:
  vortex-net:
    driver: bridge

volumes:
  vortex-data:
    driver: local
  vortex-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=4g
  vortex-sock:
    driver: local
  vortex-models:
    driver: local
